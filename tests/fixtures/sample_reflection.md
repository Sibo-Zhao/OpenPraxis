# 线上故障复盘：数据库连接池耗尽

## 经过

周三凌晨告警：API 大量 5xx，排查发现 DB 连接池被占满。重启应用后恢复，但持续有慢查询。

## 根因

- 新上的报表接口没有做分页，一次拉取全表，单请求占用连接时间过长。
- 连接池大小与实例数、单请求持有时长不匹配，未做压测验证。

## 改进

- 报表接口改为分页 + 异步导出。
- 连接池参数按压测结果调整，并加连接超时与熔断。
- 建立「上线前必须过压测」的 checklist。

## 教训

- 资源类问题（连接、内存、线程）要在设计阶段就量化，不能等到线上爆掉再补。
